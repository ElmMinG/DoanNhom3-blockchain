<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charity Token DAO | Qu·∫£n tr·ªã b·∫±ng Token</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background: radial-gradient(circle at 10% 20%, rgb(17, 24, 39) 0%, rgb(88, 28, 135) 90%); color: #fff; min-height: 100vh; display: flex; flex-direction: column; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .navbar-glass { background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-pills .nav-link.active { background-color: #8b5cf6; color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); }
        .nav-pills .nav-link { color: #9ca3af; cursor: pointer; font-weight: 600; }
        .form-dark { background: rgba(0,0,0,0.3) !important; border: 1px solid rgba(255,255,255,0.2) !important; color: #fff !important; }
        .form-dark:focus { background: rgba(0,0,0,0.5) !important; border-color: #8b5cf6 !important; color: #fff !important; box-shadow: none !important; }
        .progress-vote-container { height: 18px; background-color: rgba(0,0,0,0.4); border-radius: 10px; overflow: hidden; }
        .progress-bar-vote { height: 100%; background: linear-gradient(90deg, #10b981, #34d399); transition: width 0.6s; }
        footer { margin-top: auto; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar-glass">
        <div class="container">
            <a class="navbar-brand fw-bold fs-4" href="#"><i class="fa-solid fa-coins text-warning"></i> Charity<span class="text-primary">TokenDAO</span></a>
            <div class="d-flex align-items-center gap-3">
                <div class="d-none d-md-block text-end me-2"><small class="text-secondary d-block" style="font-size: 0.7rem;">Xin ch√†o</small><span id="webUsername" class="fw-bold text-white">Admin</span></div>
                <button class="btn btn-outline-danger btn-sm rounded-circle" onclick="logout()" title="ƒêƒÉng xu·∫•t"><i class="fa-solid fa-power-off"></i></button>
                <button id="btnConnect" class="btn btn-primary rounded-pill px-4 btn-sm" onclick="connectWallet()"><i class="fa-solid fa-wallet me-2"></i> K·∫øt n·ªëi V√≠</button>
                <div id="walletInfo" class="d-none align-items-center glass-panel px-3 py-1"><span class="font-monospace text-info small" id="myAddress">0x...</span></div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px;">
        <!-- DASHBOARD -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="glass-panel p-3 d-flex align-items-center justify-content-between h-100">
                    <div><p class="text-secondary mb-1">Qu·ªπ ETH</p><h3 class="fw-bold text-warning mb-0"><i class="fa-brands fa-ethereum"></i> <span id="poolBalance">...</span></h3></div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="glass-panel p-3 d-flex align-items-center justify-content-between h-100">
                    <div><p class="text-secondary mb-1">Token CHT c·ªßa b·∫°n</p><h3 class="fw-bold text-info mb-0" id="userTokens">0.0</h3></div>
                    <button class="btn btn-sm btn-outline-light" onclick="addTokenToMetaMask()" title="Th√™m v√†o MetaMask"><i class="fa-solid fa-plus"></i> V√≠</button>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="glass-panel p-3 d-flex align-items-center justify-content-between h-100">
                    <div><p class="text-secondary mb-1">T·ªïng cung Token</p><h3 class="fw-bold text-success mb-0" id="totalSupply">0.0</h3></div>
                </div>
            </div>
        </div>

        <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab">
            <li class="nav-item"><a class="nav-link active" onclick="switchTab('donate')">Quy√™n G√≥p & Nh·∫≠n Token</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('vote')">B·ªè Phi·∫øu (DAO)</a></li>
            <!-- ƒê√É S·ª¨A: Th√™m id="navAdmin" ƒë·ªÉ JS c√≥ th·ªÉ t√¨m v√† ·∫©n n√≥ -->
            <li class="nav-item" id="navAdmin"><a class="nav-link text-warning" onclick="switchTab('admin')">Qu·∫£n tr·ªã</a></li>
        </ul>

        <!-- TAB DONATE -->
        <div id="tab-donate" class="row justify-content-center fade-in">
            <div class="col-md-6 col-lg-5">
                <div class="glass-panel p-4 text-center">
                    <h4 class="mb-3">üíñ Quy√™n g√≥p ETH</h4>
                    <p class="text-muted small">T·ª∑ l·ªá: 1 ETH = 1000 CHT (Token qu·∫£n tr·ªã)</p>
                    <div class="mb-3"><input type="number" id="donateAmount" class="form-control form-dark text-center fw-bold" placeholder="0.01"></div>
                    <button class="btn btn-success w-100 py-2 fw-bold" onclick="donateETH()">Quy√™n G√≥p & Mint Token</button>
                </div>
            </div>
        </div>

        <!-- TAB VOTE -->
        <div id="tab-vote" class="d-none">
            <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-outline-light" onclick="loadData()"><i class="fa-solid fa-rotate"></i> C·∫≠p nh·∫≠t</button></div>
            <div class="row g-4" id="requestsList"></div>
        </div>

        <!-- TAB ADMIN -->
        <div id="tab-admin" class="d-none row justify-content-center">
            <div class="col-md-8">
                <div class="glass-panel p-4 border border-warning border-opacity-25">
                    <h4 class="text-warning mb-3">T·∫°o Y√™u C·∫ßu M·ªõi</h4>
                    <div class="mb-3"><label class="small text-secondary">M·ª•c ƒë√≠ch</label><input type="text" id="reqDesc" class="form-control form-dark"></div>
                    <div class="row mb-3">
                        <div class="col-6"><label class="small text-secondary">S·ªë ti·ªÅn (ETH)</label><input type="number" id="reqValue" class="form-control form-dark"></div>
                        <div class="col-6"><label class="small text-secondary">Th·ªùi h·∫°n Vote (Gi√¢y)</label><input type="number" id="reqDuration" class="form-control form-dark" placeholder="VD: 300 (5 ph√∫t)"></div>
                    </div>
                    <div class="mb-3"><label class="small text-secondary">Ng∆∞·ªùi nh·∫≠n</label><input type="text" id="reqRecipient" class="form-control form-dark" placeholder="0x..."></div>
                    <button class="btn btn-warning w-100 fw-bold" onclick="createRequest()">ƒê·ªá tr√¨nh</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // === ƒê·ªäA CH·ªà CONTRACT TOKEN CHU·∫®N ===
        const contractAddress = "0x71BE50E555386d156FfD0f8ab1175523A6f2Dc7e";
        
        // ABI ƒê·∫¶Y ƒê·ª¶ C·ª¶A CONTRACT TOKEN
        const contractABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
            {"inputs":[{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"address payable","name":"recipient","type":"address"},{"internalType":"uint256","name":"durationInSeconds","type":"uint256"}],"name":"createRequest","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"donate","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"finalizeRequest","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"index","type":"uint256"}],"name":"voteRequest","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getRequests","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"address payable","name":"recipient","type":"address"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"uint256","name":"voteCount","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"duration","type":"uint256"}],"internalType":"struct CharityTokenDAO.Request[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"hasVoted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"requests","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"address payable","name":"recipient","type":"address"},{"internalType":"bool","name":"completed","type":"bool"},{"internalType":"uint256","name":"voteCount","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"duration","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        let provider, signer, contract, currentAccount = null;

        // Logic Auth
        if (!localStorage.getItem('isLoggedIn')) window.location.href = 'login.html';
        
        // --- LOGIC PH√ÇN QUY·ªÄN ADMIN (M·ªöI) ---
        const userEmail = localStorage.getItem('currentUser') || 'Kh√°ch';
        document.getElementById('webUsername').innerText = userEmail;

        // ƒê·ªãnh nghƒ©a Admin c·ª©ng l√† admin@gmail.com
        if (userEmail !== 'admin@gmail.com') {
            const adminTab = document.getElementById('navAdmin');
            if(adminTab) adminTab.style.display = 'none'; // ·∫®n tab Admin n·∫øu kh√¥ng ph·∫£i admin
        }
        // ------------------------------------

        function switchTab(tab) { 
            ['donate', 'vote', 'admin'].forEach(t => document.getElementById('tab-' + t).classList.add('d-none')); 
            document.getElementById('tab-' + tab).classList.remove('d-none'); 
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
            event.target.classList.add('active'); 
        }

        async function connectWallet() {
            if (typeof window.ethereum !== "undefined") {
                try {
                    await window.ethereum.request({ method: "eth_requestAccounts" });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    currentAccount = await signer.getAddress();
                    document.getElementById('btnConnect').classList.add('d-none');
                    document.getElementById('walletInfo').classList.remove('d-none');
                    document.getElementById('walletInfo').classList.add('d-flex');
                    document.getElementById('myAddress').innerText = currentAccount.substring(0,6) + "...";
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    loadData();
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ƒê√£ k·∫øt n·ªëi', timer: 1500 });
                } catch (error) { Swal.fire('L·ªói', error.message, 'error'); }
            } else { Swal.fire('L·ªói', 'C√†i MetaMask ƒëi b·∫°n ∆°i', 'error'); }
        }

        async function loadData() {
            if (!contract) return;
            try {
                const balance = await contract.getBalance();
                document.getElementById('poolBalance').innerText = ethers.utils.formatEther(balance);
                
                const userBal = await contract.balanceOf(currentAccount);
                document.getElementById('userTokens').innerText = ethers.utils.formatEther(userBal);

                const totalSupply = await contract.totalSupply();
                document.getElementById('totalSupply').innerText = ethers.utils.formatEther(totalSupply);

                const requests = await contract.getRequests();
                renderRequests(requests, totalSupply);
            } catch (error) { console.error(error); }
        }

        function renderRequests(requests, totalSupply) {
            const list = document.getElementById('requestsList');
            list.innerHTML = "";
            if (requests.length === 0) { list.innerHTML = "<div class='text-center'>Ch∆∞a c√≥ y√™u c·∫ßu</div>"; return; }

            const total = parseFloat(ethers.utils.formatEther(totalSupply)) || 1; 

            [...requests].reverse().forEach((req) => {
                const voteCount = parseFloat(ethers.utils.formatEther(req.voteCount));
                const pct = Math.min((voteCount / total) * 100, 100);
                
                const now = Math.floor(Date.now() / 1000);
                const endTime = parseInt(req.startTime) + parseInt(req.duration);
                const timeLeft = endTime - now;
                const timeString = timeLeft > 0 ? `${Math.floor(timeLeft/60)} ph√∫t c√≤n l·∫°i` : "ƒê√£ h·∫øt h·∫°n";
                const isExpired = timeLeft <= 0;

                list.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="glass-panel p-3 h-100 d-flex flex-column ${req.completed ? 'border-success' : ''}">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-secondary">#${req.id}</span>
                            ${req.completed ? '<span class="badge bg-success">Ho√†n th√†nh</span>' : `<span class="badge ${isExpired ? 'bg-danger' : 'bg-warning text-dark'}">${timeString}</span>`}
                        </div>
                        <h5 class="fw-bold">${req.description}</h5>
                        <p class="small text-secondary mb-1">To: ${req.recipient.substring(0,6)}...</p>
                        <h3 class="text-warning">${ethers.utils.formatEther(req.value)} ETH</h3>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between small text-muted">
                                <span>Vote: ${voteCount.toFixed(1)} CHT</span>
                                <span>${pct.toFixed(1)}%</span>
                            </div>
                            <div class="progress-vote-container mb-3"><div class="progress-bar-vote" style="width: ${pct}%"></div></div>
                            
                            ${!req.completed ? `
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-light btn-sm w-50" onclick="voteRequest(${req.id})" ${isExpired ? 'disabled' : ''}>üëç Vote</button>
                                    <button class="btn btn-primary btn-sm w-50" onclick="finalizeRequest(${req.id})">üöÄ R√∫t</button>
                                </div>
                            ` : '<button class="btn btn-secondary btn-sm w-100" disabled>ƒê√£ gi·∫£i ng√¢n</button>'}
                        </div>
                    </div>
                </div>`;
            });
        }

        async function donateETH() {
            const val = document.getElementById('donateAmount').value;
            if (!val) return;
            try {
                const tx = await contract.donate({ value: ethers.utils.parseEther(val) });
                Swal.fire({title: 'ƒêang x·ª≠ l√Ω...', didOpen: () => Swal.showLoading()});
                await tx.wait();
                Swal.fire('Th√†nh c√¥ng', 'B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c Token CHT!', 'success');
                loadData();
            } catch (err) { Swal.fire('L·ªói', err.reason || err.message, 'error'); }
        }

        async function createRequest() {
            const desc = document.getElementById('reqDesc').value;
            const val = document.getElementById('reqValue').value;
            const duration = document.getElementById('reqDuration').value;
            const rec = document.getElementById('reqRecipient').value;
            try {
                const tx = await contract.createRequest(desc, ethers.utils.parseEther(val), rec, duration);
                Swal.fire({title: 'ƒêang t·∫°o...', didOpen: () => Swal.showLoading()});
                await tx.wait();
                Swal.fire('Th√†nh c√¥ng', 'Y√™u c·∫ßu ƒë√£ ƒë∆∞·ª£c t·∫°o', 'success');
                loadData();
            } catch (err) { Swal.fire('L·ªói', err.reason || err.message, 'error'); }
        }

        async function voteRequest(id) {
            try {
                const tx = await contract.voteRequest(id);
                Swal.fire({title: 'ƒêang Vote...', didOpen: () => Swal.showLoading()});
                await tx.wait();
                Swal.fire('ƒê√£ Vote!', 'Token c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n', 'success');
                loadData();
            } catch (err) { Swal.fire('L·ªói', err.reason || err.message, 'error'); }
        }

        async function finalizeRequest(id) {
            try {
                const tx = await contract.finalizeRequest(id);
                Swal.fire({title: 'ƒêang r√∫t...', didOpen: () => Swal.showLoading()});
                await tx.wait();
                Swal.fire('Th√†nh c√¥ng', 'Ti·ªÅn ƒë√£ chuy·ªÉn ƒëi', 'success');
                loadData();
            } catch (err) { Swal.fire('L·ªói', err.reason || err.message, 'error'); }
        }

        async function addTokenToMetaMask() {
            try {
                await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: contractAddress,
                            symbol: 'CHT',
                            decimals: 18,
                            image: 'https://cdn-icons-png.flaticon.com/512/6270/6270515.png',
                        },
                    },
                });
            } catch (error) { console.error(error); }
        }

        function logout() { localStorage.removeItem('isLoggedIn'); window.location.href = 'login.html'; }
    </script>
</body>
</html>